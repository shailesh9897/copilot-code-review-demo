name: AI Code Review
on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get PR diff
        id: diff
        run: |
          git fetch origin main
          git diff origin/main > diff.txt
          echo "DIFF<<EOF" >> $GITHUB_ENV
          cat diff.txt >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Run AI Review
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          pip install openai==1.3.5 requests
          python3 - <<'PY'
  import os, openai, requests
  
  openai.api_key = os.environ["OPENAI_API_KEY"]
  diff = os.environ["DIFF"]
  
  prompt = f"""
You are a senior Java code reviewer. Review this diff and comment on:
  - Null safety
  - SQL/Resource handling
  - Logging/PII
  - Performance inefficiencies
  - General best practices

  Reply with clear, structured bullet points (no generic praise).
Here is the diff:
  {diff}
  """

resp = openai.ChatCompletion.create(
    model="gpt-4-turbo",
messages=[{"role": "user", "content": prompt}],
  temperature=0.3
  )
  
  review = resp.choices[0].message.content
  
  print("AI Review:\n", review)
  
  # Post comment to PR
  import os
  import requests
  pr_url = os.environ["GITHUB_API_URL"] + "/repos/" + os.environ["GITHUB_REPOSITORY"] + "/issues/" + str(os.environ["GITHUB_REF"].split('/')[-1]) + "/comments"
  token = os.environ["GITHUB_TOKEN"]
headers = {"Authorization": f"token {token}"}
data = {"body": f"ðŸ¤– **AI Code Review Bot says:**\n\n{review}"}
  requests.post(pr_url, headers=headers, json=data)
  PY
