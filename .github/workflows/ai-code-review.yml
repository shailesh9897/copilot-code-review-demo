name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    env:
      # Fast, lightweight model for quick reviews (‚âà7B, q4 quant)
      OLLAMA_MODEL: 'mistral:7b-instruct-q4_K_M'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Python deps
        run: |
          python3 -m pip install --upgrade pip
          pip install requests

      - name: Restore Ollama model cache
        uses: actions/cache@v4
        with:
          path: ~/.ollama
          key: ollama-${{ env.OLLAMA_MODEL }}

      - name: Install & start Ollama
        run: |
          set -e
          curl -fsSL https://ollama.com/install.sh | sh
          nohup ollama serve > /tmp/ollama.log 2>&1 &

          echo "Waiting for Ollama API..."
          for i in {1..120}; do
            if curl -sf http://127.0.0.1:11434/api/tags >/dev/null; then
              echo "Ollama is up"; break
            fi
            sleep 1
          done

          echo "Pulling model: ${OLLAMA_MODEL}"
          for i in {1..5}; do
            if ollama pull "${OLLAMA_MODEL}"; then break; fi
            echo "Retry pull ($i/5)..."; sleep 10
          done

          echo "Verifying model..."
          ollama show "${OLLAMA_MODEL}"

          echo "Warming model..."
          ollama run "${OLLAMA_MODEL}" "OK." >/dev/null || true

      - name: Generate and post AI review
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO:         ${{ github.repository }}
          PR_NUMBER:    ${{ github.event.pull_request.number }}
          BASE_SHA:     ${{ github.event.pull_request.base.sha }}
          HEAD_SHA:     ${{ github.event.pull_request.head.sha }}
          OLLAMA_MODEL: ${{ env.OLLAMA_MODEL }}
        run: |
          set -e
          git fetch --no-tags --prune --depth=1 origin "${BASE_SHA}" "${HEAD_SHA}"
          git diff --unified=0 "${BASE_SHA}" "${HEAD_SHA}" > diff.txt || true
          python3 - <<'PY'
          import os, json, requests, sys, pathlib, time, re

          repo = os.environ["REPO"]
          pr   = os.environ["PR_NUMBER"]
          gh_headers = {
              "Authorization": f"Bearer {os.environ['GITHUB_TOKEN']}",
              "Accept": "application/vnd.github+json"
          }

          def comment(body: str):
              url = f"https://api.github.com/repos/{repo}/issues/{pr}/comments"
              r = requests.post(url, headers=gh_headers, json={"body": body})
              print("Comment status:", r.status_code, r.text[:200])

          diff_path = pathlib.Path("diff.txt")
          if not diff_path.exists() or diff_path.stat().st_size == 0:
              comment("ü§ñ **AI Code Review Bot:** No diff content detected for this PR.")
              sys.exit(0)

          diff = diff_path.read_text(encoding="utf-8", errors="ignore")
          MAX_CHARS = 20000  # keep it small for speed on 7B models
          if len(diff) > MAX_CHARS:
              diff = diff[:MAX_CHARS//2] + "\n\n[...snip...]\n\n" + diff[-MAX_CHARS//2:]

          prompt = """You are a senior Java/Spring reviewer.
          Review this unified git diff and return concise bullet points.

          Focus:
          - Null-safety / possible NPEs
          - SQL & resource handling (PreparedStatement, try-with-resources)
          - Logging & PII masking
          - Performance (boxing, streams, loops)
          - Spring/Java best practices

          Rules:
          - If everything looks good with no meaningful issues, respond exactly:
            ü§ñ AI Code Review Bot: Good to merge
          - Otherwise, list concise bullet points for the problem areas.

          Diff:
          """ + diff

          body = {
              "model": os.environ.get("OLLAMA_MODEL","mistral:7b-instruct-q4_K_M"),
              "messages": [{"role":"user","content": prompt}],
              "stream": False
          }

          last_err = None
          for i in range(6):
              try:
                  r = requests.post(
                      "http://127.0.0.1:11434/api/chat",
                      headers={"Content-Type":"application/json"},
                      data=json.dumps(body),
                      timeout=480
                  )
                  if r.status_code >= 500:
                      last_err = f"HTTP {r.status_code}"; time.sleep(8*(i+1)); continue
                  r.raise_for_status()
                  review = (r.json().get("message") or {}).get("content","").strip()

                  # Map common ‚Äúno issues‚Äù phrasings to the single-line success message
                  normalized = re.sub(r'\s+', ' ', (review or '')).strip().lower()
                  if not normalized or normalized in {"no issues found", "no issues found."}:
                      review = "ü§ñ AI Code Review Bot: Good to merge"
                  elif "good to merge" in normalized and "ai code review bot" in normalized:
                      review = "ü§ñ AI Code Review Bot: Good to merge"

                  comment(review)
                  sys.exit(0)
              except Exception as e:
                  last_err = str(e); time.sleep(8*(i+1))

          comment(f"‚ö†Ô∏è Ollama error after retries: {last_err}")
          PY
